import React, { useState, useEffect, useCallback } from 'react';
import { ChevronLeft, MapPin, Clock, Timer, Landmark, Leaf, ShoppingBag, BookOpen, Utensils, Zap, Loader2 } from "lucide-react";

// --- MOCK DEPENDENCIES ---
const regions = [
    { id: 1, name: "Nukus", image: "https://placehold.co/600x400/0000FF/FFFFFF?text=Nukus", description: "Qoraqalpog'iston poytaxti" },
    { id: 2, name: "Moynaq", image: "https://placehold.co/600x400/808080/FFFFFF?text=Moynaq", description: "Aral dengizi fojiasi joyi" },
    { id: 3, name: "Konye-Urgench", image: "https://placehold.co/600x400/FFA500/000000?text=Konye-Urgench", description: "Qadimiy Xorazm xarobalari" },
    { id: 4, name: "Taxtakupir", image: "https://placehold.co/600x400/33A333/FFFFFF?text=Taxtakupir", description: "Tabiat va qo'riqxonalar" },
];

const times = ["1 soat", "2 soat", "3 soat", "Yarim kun", "To'liq kun"];
const interests = ["Tarix", "Muzeylar", "Oziq-ovqat", "Tabiat", "Xarid"];

// --- UTILITY FUNCTIONS ---

// Qiziqish turiga qarab mos ikonani tanlaydi
const getInterestIcon = (interest) => {
    // interest massiv bo'lishi mumkin
    const primaryInterest = Array.isArray(interest) ? interest[0] : interest?.split(',')[0];
    const IconProps = { className: "w-6 h-6 mr-2 text-orange-500 flex-shrink-0" };

    switch (primaryInterest?.toLowerCase().trim()) {
        case "tarix":
            return <Landmark {...IconProps} />;
        case "muzeylar":
            return <BookOpen {...IconProps} />;
        case "oziq-ovqat":
            return <Utensils {...IconProps} />;
        case "tabiat":
            return <Leaf {...IconProps} />;
        case "xarid":
            return <ShoppingBag {...IconProps} />;
        default:
            return <Zap {...IconProps} />;
    }
};

// --- AI API CALLS ---

// Marshrutning matnini va joylarning rasm promptlarini generatsiya qiladi
const generateTextRoute = async ({ location, time, interest }) => {
    const GEMINI_API_KEY = ""; 
    const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
    const apiKey = GEMINI_API_KEY;

    const interestString = interest.join(", ");

    const prompt = `
    Sen Baramiz AI marshrut generatorisan. O'zbekistondagi real geografik joylar va vaqtlarini bilasan.
    Foydalanuvchi quyidagi ma'lumotlarni berdi:
    - Shahar: ${location}
    - Vaqt: ${time}
    - Qiziqish: ${interestString}

    QOIDALAR:
    1) Marshrutni faqat shu vaqtga moslab tuz.
    2) Marshrut 2 dan 4 tagacha joydan iborat bo'lsin.
    3) description (ta'rif) tushunarli va qiziqarli bo'lsin (O'zbek tilida yozing).
    4) image_prompt maydoniga joyning SIFATLI, FOTOREALISTIK inglizcha ta'rifini kiriting (rasm generatsiya qilish uchun). Faqat ingliz tilida yozing.
    5) Yakunda umumiy sarflangan vaqtni ("total_trip_time") hisobla.

    Javobni faqat JSON formatida qaytar.
    `;
    
    // JSON Schema
    const routeSchema = {
        type: "OBJECT",
        properties: {
            total_trip_time: { type: "STRING", description: "Umumiy marshrutga ketgan vaqtni hisoblab yozing (masalan: 2 soat 15 minut)" },
            route: {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        name: { type: "STRING", description: "Joyning nomi (O'zbek tilida)" },
                        description: { type: "STRING", description: "Joyning qisqacha ta'rifi (O'zbek tilida)" },
                        travel_time: { type: "STRING", description: "Oldingi joydan bu joyga borish vaqti (masalan: 10 minut piyoda)" },
                        stay_time: { type: "STRING", description: "Bu joyda qolishga tavsiya etilgan vaqt (masalan: 1 soat)" },
                        total: { type: "STRING", description: "Bu joyga borish va unda qolish uchun ketgan umumiy vaqt (masalan: 1 soat 10 minut)" },
                        image_prompt: { type: "STRING", description: "A detailed, photorealistic English description suitable for high-quality image generation of this specific location." },
                    },
                    required: ["name", "description", "travel_time", "stay_time", "total", "image_prompt"]
                }
            }
        },
        required: ["total_trip_time", "route"]
    };

    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;
    let attempts = 0;
    const maxAttempts = 3;

    while (attempts < maxAttempts) {
        try {
            const response = await fetch(apiUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: routeSchema,
                    }
                })
            });

            if (!response.ok) {
                const errorBody = await response.json();
                throw new Error(`API so'rovi xatosi: ${response.status} - ${errorBody.error?.message || 'Noma\'lum xato'}`);
            }

            const result = await response.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (jsonText) {
                const cleanJsonText = jsonText.replace(/```json|```/g, '').trim();
                return JSON.parse(cleanJsonText);
            }
            throw new Error("AI dan bo'sh yoki noto'g'ri JSON javobi keldi.");

        } catch (error) {
            attempts++;
            if (attempts < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, attempts - 1))); // Exponential backoff
            } else {
                throw new Error(`AI marshrutini generatsiya qilishda xatolik yuz berdi. Tafsilot: ${error.message}`);
            }
        }
    }
};

// Har bir joy uchun rasm generatsiya qiladi
const generateImage = async (prompt) => {
    const apiKey = ""; 
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;

    const payload = {
        instances: [{ prompt: prompt + ", photorealistic, professional travel photography, cinematic lighting, Uzbekistan" }],
        parameters: {
            "sampleCount": 1,
            "aspectRatio": "16:9" 
        }
    };

    let attempts = 0;
    const maxAttempts = 3;

    while (attempts < maxAttempts) {
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                throw new Error(`Image API error: ${response.status}`);
            }

            const result = await response.json();
            
            if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
            } else {
                throw new Error("Rasm generatsiya qilinmadi (Bo'sh javob).");
            }

        } catch (error) {
            attempts++;
            if (attempts < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, attempts - 1))); // Exponential backoff
            } else {
                throw new Error(`Rasm generatsiya qilishda xatolik yuz berdi. Tafsilot: ${error.message}`);
            }
        }
    }
};


// --- GENERATED ROUTE DISPLAY COMPONENT (Based on user's CreateRoute) ---
const GeneratedRouteDisplay = ({ city, time, interest, onBack }) => {
    // State management for AI results and loading
    const [routeResult, setRouteResult] = useState(null);
    const [loading, setLoading] = useState(false);
    const [imageLoading, setImageLoading] = useState(false);
    const [error, setError] = useState(null);
    const [imageUrls, setImageUrls] = useState({});

    const interestDisplay = interest.join(", ");
    const InterestIcon = getInterestIcon(interest);

    const fetchRoute = useCallback(async () => {
        setLoading(true);
        setError(null);
        setRouteResult(null);
        setImageUrls({});
        
        let routeData;
        try {
            routeData = await generateTextRoute({ location: city, time, interest });
            setRouteResult(routeData);

            if (routeData && routeData.route) {
                await generateImagesForRoute(routeData.route);
            }
        } catch (err) {
            console.error("Route generation failed:", err);
            setError(err.message || "Marshrutni generatsiya qilishda kutilmagan xato yuz berdi.");
        } finally {
            setLoading(false);
        }
    }, [city, time, interest]);

    useEffect(() => {
        window.scrollTo({ top: 0, behavior: "smooth" });
        fetchRoute();
    }, [fetchRoute]);

    const generateImagesForRoute = async (route) => {
        setImageLoading(true);
        const imagePromises = route.map(async (item, index) => {
            if (item.image_prompt) {
                try {
                    const url = await generateImage(item.image_prompt);
                    setImageUrls(prev => ({ ...prev, [index]: url })); 
                } catch (error) {
                    setImageUrls(prev => ({ ...prev, [index]: 'error' }));
                    console.error(`Error generating image for step ${index + 1}:`, error);
                }
            }
        });

        await Promise.all(imagePromises);
        setImageLoading(false);
    };

    const overallLoading = loading || imageLoading;

    // The component structure is now wrapped in a single max-width container 
    // replacing the external 'Container' component.
    return (
        <div className="pb-20 pt-8">
            <div className="max-w-4xl mx-auto px-4 sm:px-6"> {/* Container Replacement */}
                <>
                    {/* Motion removed, only div remains */}
                    <div className="animate-in fade-in-0 duration-500">
                        {onBack && (
                            <button
                                onClick={onBack}
                                className="mt-8 mb-6 text-orange-500 hover:text-orange-600 flex items-center gap-1 font-semibold text-lg transition duration-200"
                            >
                                <ChevronLeft className="w-6 h-6" />
                                Orqaga
                            </button>
                        )}

                        <h1 className="text-4xl md:text-5xl font-extrabold text-gray-800 mb-4 flex items-center">
                            <MapPin className="inline-block w-8 h-8 mr-3 text-orange-500 flex-shrink-0" />
                            Marshrut <span className="text-orange-500 ml-2">{city}</span> shahri uchun
                        </h1>

                        <div className="flex flex-wrap gap-x-8 gap-y-4 text-xl text-gray-700 mb-12 border-b pb-4">
                            <p className="flex items-center gap-2">
                                <Timer className="w-6 h-6 text-orange-500" />
                                Vaqt: {time}
                            </p>
                            <p className="flex items-center gap-2">
                                {InterestIcon}
                                Qiziqish: {interestDisplay}
                            </p>
                        </div>

                        {/* Loading / Error Messages */}
                        {overallLoading && (
                            <div className="text-center p-8 bg-yellow-50 border border-yellow-200 rounded-xl shadow-lg mb-8">
                                <div className="flex flex-col items-center">
                                    <Loader2 className="w-10 h-10 text-yellow-600 animate-spin mb-4" />
                                    <p className="text-xl font-semibold text-yellow-800 mb-2">Marshrut generatsiyasi davom etmoqda...</p>
                                    {loading && <p className="text-sm text-yellow-700">1/2: Marshrut sxemasini yaratish (AI)...</p>}
                                    {imageLoading && !loading && <p className="text-sm text-yellow-700">2/2: Joylarning vizual rasmlarini tayyorlash (AI Image)...</p>}
                                </div>
                            </div>
                        )}

                        {error && (
                            <div className="text-center p-8 bg-red-50 border border-red-400 text-red-700 rounded-xl shadow-lg mb-8">
                                <p className="font-bold text-xl mb-2">Xato yuz berdi!</p>
                                <p>{error}</p>
                                <button
                                    onClick={fetchRoute}
                                    className="mt-4 bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition"
                                >
                                    Qayta urinish
                                </button>
                            </div>
                        )}

                        {routeResult && routeResult.route && (
                             <h2 className="text-3xl font-bold mb-8 flex items-center">
                                <MapPin className="w-7 h-7 mr-3 text-orange-500" />
                                Tavsiya etilgan joylar: <span className="text-orange-500 ml-2">{interestDisplay}</span>
                             </h2>
                        )}
                        
                    </div>
                </>

                {/* AI Generated Route Content */}
                {routeResult && routeResult.route ? (
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8 mt-10">
                        {routeResult.route.map((item, i) => {
                            const imageUrl = imageUrls[i];
                            const isImageReady = imageUrl && imageUrl !== 'error';

                            return (
                                <div
                                    key={i}
                                    // Motion removed, using simple classes for dynamic effect
                                    className="rounded-xl overflow-hidden shadow-xl border border-gray-100 bg-white hover:shadow-2xl transition-shadow duration-300 transform hover:scale-[1.02]"
                                >
                                    
                                    {/* Image Display Area (Replacing p.img) */}
                                    <div className="h-[200px] rounded-t-xl overflow-hidden w-full aspect-video bg-gray-100 flex items-center justify-center">
                                        {isImageReady ? (
                                            <img 
                                                src={imageUrl} 
                                                alt={`Rasm: ${item.name}`} 
                                                className="w-full h-full object-cover transition-opacity duration-500"
                                                loading="lazy"
                                            />
                                        ) : imageUrl === 'error' ? (
                                            <p className="text-red-500 text-center p-4">Rasm generatsiya qilinmadi.</p>
                                        ) : (
                                            <div className="flex flex-col items-center justify-center p-4">
                                                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500 mb-2"></div>
                                                <p className="text-gray-500 text-sm text-center">Rasm yuklanmoqda...</p>
                                            </div>
                                        )}
                                    </div>

                                    <div className="p-5">
                                        {/* Name (Replacing p.title.en) */}
                                        <p className="text-xl font-bold text-gray-800 mb-2">
                                            {item.name}
                                        </p>
                                        
                                        {/* Description */}
                                        <p className="text-gray-600 mb-3 text-sm">{item.description}</p>
                                        
                                        {/* Duration (Replacing p.duration) */}
                                        <div className="flex flex-col gap-1 text-sm pt-2 border-t border-gray-100">
                                            <p className="text-gray-700 flex items-center gap-1">
                                                <Timer className="w-4 h-4 text-orange-500" />
                                                Joyda qolish vaqti: <span className='font-semibold'>{item.stay_time}</span>
                                            </p>
                                            <p className="text-gray-700 flex items-center gap-1">
                                                <Clock className="w-4 h-4 text-orange-500" />
                                                Borish vaqti: <span className='font-semibold'>{item.travel_time}</span>
                                            </p>
                                            <p className="text-lg font-bold text-blue-700 flex items-center gap-1 mt-2">
                                                Jami: {item.total}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                ) : !overallLoading && !error ? (
                    <p className="text-gray-500 text-lg p-4 border rounded-xl bg-gray-50">
                        Tanlangan mezonlarga mos keladigan marshrut topilmadi. Iltimos, boshqa qiziqish turini yoki vaqtni tanlang.
                    </p>
                ) : null}

                {routeResult && !overallLoading && (
                    <p className="text-2xl font-extrabold mt-8 pt-4 border-t-2 border-dashed border-gray-300 text-gray-800 text-center">
                        Umumiy sayohat vaqti: <span className="text-orange-500">{routeResult.total_trip_time}</span>
                    </p>
                )}
            </div>
        </div>
    );
}

// --- MAIN APP COMPONENT ---
const App = () => {
    const [isRouteCreated, setIsRouteCreated] = useState(false);
    const [city, setCity] = useState(null);
    const [time, setTime] = useState(null);
    const [interest, setInterest] = useState([]);

    const handleInterestToggle = (item) => {
        setInterest((prevInterests) => {
            if (prevInterests.includes(item)) {
                return prevInterests.filter((i) => i !== item);
            } else {
                return [...prevInterests, item]; 
            }
        });
    };

    const handleCreateRoute = () => {
        if (city && time && interest.length > 0) {
            setIsRouteCreated(true);
        } else {
            // Simple visual feedback 
            const feedbackElement = document.getElementById('required-feedback');
            if (feedbackElement) {
                feedbackElement.classList.remove('hidden');
                setTimeout(() => {
                    feedbackElement.classList.add('hidden');
                }, 3000);
            }
        }
    };

    if (isRouteCreated) {
        return (
            <GeneratedRouteDisplay
                city={city}
                time={time}
                interest={interest}
                onBack={() => setIsRouteCreated(false)}
            />
        );
    }

    return (
        <main className="px-4 py-10 min-h-screen bg-gray-50 font-sans">
            <div className="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-xl"> 
                <h1 className="text-center text-4xl font-extrabold mb-12 text-gray-800">
                    üó∫Ô∏è <span className="text-orange-600">Qoraqalpog'iston</span> bo'ylab marshrutni yarating
                </h1>

                {/* 1. Shahar tanlash */}
                <div className="mb-12 border-b pb-6">
                    <p className="text-2xl font-semibold mb-6 text-gray-700">1. Shaharni tanlang</p>
                    <div 
                        className="flex overflow-x-auto gap-4 pb-4 snap-x snap-mandatory"
                        style={{ scrollbarWidth: 'none', WebkitOverflowScrolling: 'touch' }} 
                    >
                        {regions.map((c) => (
                            <div 
                                key={c.id} 
                                onClick={() => setCity(c.name)}
                                className={`flex-none w-[200px] sm:w-[250px] h-[180px] rounded-xl overflow-hidden cursor-pointer border-4 transition relative shadow-md snap-start 
                                ${city === c.name
                                        ? "border-orange-500 ring-4 ring-orange-300 shadow-xl scale-[1.03]"
                                        : "border-gray-200 hover:border-orange-400"
                                    }`}
                            >
                                <img
                                    src={c.image}
                                    className="w-full h-full object-cover transition duration-300 ease-in-out hover:opacity-80"
                                    alt={c.name}
                                    onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/600x400/374151/ffffff?text=Image+Not+Found" }}
                                />
                                <div className="absolute inset-0 bg-black bg-opacity-30 flex items-end p-3">
                                    <p className="text-white text-xl font-bold drop-shadow-lg">
                                        {c.name}
                                    </p>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>

                {/* 2. Vaqt tanlash */}
                <div className="mb-12 border-b pb-6">
                    <p className="text-2xl font-semibold mb-6 text-gray-700">2. Vaqtni tanlang</p>
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4">
                        {times.map((t) => (
                            <button
                                key={t}
                                onClick={() => setTime(t)}
                                className={`py-3 rounded-xl border text-lg transition duration-300 font-semibold shadow-sm
                                ${time === t ? "bg-orange-500 text-white border-orange-600 shadow-md transform scale-[1.02]" : "text-gray-600 border-gray-300 hover:bg-orange-50"}`}
                            >
                                {t}
                            </button>
                        ))}
                    </div>
                </div>

                {/* 3. Qiziqish turini tanlash */}
                <div className="mb-12">
                    <p className="text-2xl font-semibold mb-6 text-gray-700">3. Qiziqish turini tanlang</p>
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4">
                        {interests.map((i) => (
                            <button
                                key={i}
                                onClick={() => handleInterestToggle(i)}
                                className={`py-3 px-4 rounded-xl border text-lg transition duration-300 font-semibold shadow-sm
                                ${interest.includes(i)
                                        ? "bg-orange-500 text-white border-orange-600 shadow-md transform scale-[1.02]"
                                        : "text-gray-600 border-gray-300 hover:bg-orange-50"
                                    }`}
                            >
                                {i}
                            </button>
                        ))}
                    </div>
                </div>

                {/* Talab qilinadigan maydonlar bo'yicha fikr-mulohaza */}
                <div id="required-feedback" className="hidden fixed bottom-5 left-1/2 transform -translate-x-1/2 p-3 bg-red-500 text-white rounded-lg shadow-2xl z-50 transition-opacity duration-300">
                    Iltimos, shahar, vaqt va kamida bitta qiziqish turini tanlang.
                </div>

                {/* Marshrutni tuzish tugmasi */}
                <div className="flex justify-center mt-12">
                    <button
                        onClick={handleCreateRoute}
                        disabled={!city || !time || interest.length === 0}
                        className={`p-4 rounded-xl transition duration-300 font-extrabold text-xl shadow-lg transform hover:scale-[1.03] active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-orange-300
                            ${!city || !time || interest.length === 0
                                ? "bg-gray-400 text-gray-200 cursor-not-allowed"
                                : "bg-orange-500 hover:bg-orange-600 text-white"
                            }`}
                    >
                        Marshrutni tuzish
                    </button>
                </div>
            </div>
        </main>
    );
}

export default App;